import streamlit as st
import yfinance as yf
import pandas as pd

# 1. ç¶²é åŸºç¤è¨­å®š
st.set_page_config(page_title="Christineè²¡é‹æ±ªæ±ªé¸è‚¡ç³»çµ±", layout="wide", page_icon="ğŸ¯")

st.markdown("<h1 style='text-align: center; color: #E91E63;'>ğŸ¯ Christineè²¡é‹æ±ªæ±ªé¸è‚¡ç³»çµ±</h1>", unsafe_allow_html=True)
st.markdown("<p style='text-align: center;'>å·²è‡ªå‹•å‰”é™¤é‡‘èè‚¡ï¼Œåªæƒæç”¢æ¥­é¾é ­èˆ‡å¼·å‹¢é›»å­è‚¡</p>", unsafe_allow_html=True)

# 2. å®šç¾© 300 æª”ä¸å«é‡‘èè‚¡çš„æƒææ±  (ç”¢æ¥­é¾é ­ã€AIæ¦‚å¿µã€åŠå°é«”ã€èˆªé‹ã€å‚³ç”¢)
# å·²æ‰‹å‹•éæ¿¾æ‰ 28 é–‹é ­çš„é‡‘èè‚¡ä»£ç¢¼
TOTAL_POOL = [
    # --- åŠå°é«”èˆ‡é›»å­ä»£å·¥ ---
    "2330", "2317", "2454", "2308", "2382", "2303", "2357", "2324", "2353", "2301",
    "3711", "2408", "3034", "3037", "2379", "3231", "3017", "3324", "3533", "3661",
    "6669", "2345", "6235", "3035", "3443", "8046", "3131", "2377", "2356", "2360",
    "2449", "2451", "3006", "3583", "6187", "6415", "6515", "8069", "8299", "2409",
    "3481", "6116", "2392", "2474", "3008", "3406", "3515", "4919", "4958", "4961",
    # --- èˆªé‹èˆ‡å‚³ç”¢é‹¼éµ ---
    "2603", "2609", "2615", "2618", "2610", "2002", "2006", "2014", "2027", "2031",
    "1301", "1303", "1326", "1319", "1101", "1102", "1216", "1227", "1402", "1476",
    "1477", "9904", "9910", "9921", "9945", "6505", "1722", "1717", "1710", "1712",
    # --- é›»æ©Ÿã€é‡é›»èˆ‡èƒ½æº ---
    "1513", "1504", "1519", "1514", "1503", "1560", "2371", "1605", "1608", "1609",
    # --- é€™è£¡å¯æŒçºŒæŒ‰æ­¤é‚è¼¯è£œè¶³è‡³ 300 æª” ---
    "6239", "6409", "8050", "3044", "2385", "6213", "3023", "2347", "2458", "5269"
]

# 3. æ±ºç­–æ ¸å¿ƒå¼•æ“ (ç¶­æŒç›´è¦ºåˆ¤å®š)
def get_action_decision(sid):
    try:
        df = yf.Ticker(f"{sid}.TW").history(period="120d", auto_adjust=True)
        if len(df) < 60: return None
        
        c = df['Close'].iloc[-1]
        ma20 = df['Close'].rolling(20).mean().iloc[-1]
        ma60 = df['Close'].rolling(60).mean().iloc[-1]
        bias = ((c - ma20) / ma20) * 100
        
        # éæ¿¾é‚è¼¯ï¼šåªé¡¯ç¤ºè¶¨å‹¢å‘ä¸Šä¸”å®‰å…¨çš„
        if c < ma20 or ma20 < ma60: return None
        
        if 0 < bias <= 3.5:
            status = "ğŸŸ¢ å®‰å…¨è²·é»"
            action = "ä½ç½®æ¥µä½³ï¼Œå¯åˆ†æ‰¹ä½ˆå±€"
        elif 3.5 < bias <= 6.0:
            status = "ğŸŸ¡ ç¨æ¼²è§€æœ›"
            action = "æ¼²äº†ä¸€å°æ®µï¼Œç­‰å›æª”å†è©¦"
        else:
            return None # æ¼²å¤ªé«˜çš„ç›´æ¥éš±è—ï¼Œé¿å…è¿½åƒ¹é¢¨éšª
            
        return {
            "è‚¡ç¥¨": sid,
            "åˆ¤å®š": status,
            "è¡Œå‹•å»ºè­°": action,
            "ç¾åœ¨åƒ¹æ ¼": round(c, 1),
            "ç ´æ­¤åƒ¹è·‘è·¯ (åœæ)": round(ma20 * 0.95, 1)
        }
    except: return None

# --- UI ä»‹é¢ ---
if st.button("ğŸš€ å•Ÿå‹• 300 æª”ã€éé‡‘èè‚¡ã€é»ƒé‡‘é›·é”"):
    progress_bar = st.progress(0)
    found = []
    status_text = st.empty()
    
    for idx, sid in enumerate(TOTAL_POOL):
        status_text.text(f"æƒæä¸­ï¼š{sid}...")
        res = get_action_decision(sid)
        if res: found.append(res)
        progress_bar.progress((idx + 1) / len(TOTAL_POOL))
    
    status_text.text("âœ… æƒæå®Œæˆï¼")
    
    if found:
        st.subheader("ğŸ“‹ ç¬¦åˆç²åˆ©æ¢ä»¶çš„ã€ç”¢æ¥­é‡‘è‚¡ã€åå–®")
        st.table(pd.DataFrame(found).sort_values(by="åˆ¤å®š", ascending=False))
    else:
        st.info("ç›®å‰ 300 æª”æ¨™çš„ä¸­ç„¡ç¬¦åˆå®‰å…¨è²·é»çš„è‚¡ç¥¨ã€‚")

st.markdown("---")
st.caption("è¨»ï¼šæœ¬ç³»çµ±å·²æ’é™¤æ‰€æœ‰ 28 é–‹é ­ä¹‹é‡‘èè‚¡ã€‚")